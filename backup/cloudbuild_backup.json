{
    "timeout": "5400s",
    "logsBucket": "gs://${PROJECT_ID}_cloudbuild",
    "steps": [
        {
            "name": "gcr.io/cloud-builders/git",
            "args": [
                "clone",
                "--branch=${_DCAT_DEPLOY_BRANCH_NAME}",
                "https://github.com/vwt-digital/dcat-deploy.git"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gsutil",
            "args": [
                "cp",
                "gs://${PROJECT_ID}-dcat-deployed-stg/data_catalog.json",
                "."
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gcloud",
            "dir": "dcat-deploy/backup",
            "entrypoint": "bash",
            "args": [
                "-c",
                "pip install virtualenv==16.7.9 && virtualenv -p python3 venv && source venv/bin/activate && pip install -r requirements.txt"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gcloud",
            "entrypoint": "bash",
            "args": [
                "-c",
                "source dcat-deploy/backup/venv/bin/activate && dcat-deploy/backup/run_backup.sh data_catalog.json ${PROJECT_ID} ${_DEST_BUCKET} ${_KEYRING_REGION} ${_KEYRING} ${_KEY} ${_ENCRYPTED_GITHUB_TOKEN}"
            ]
        }
    ],
    "substitutions": {
        "_DCAT_DEPLOY_BRANCH_NAME": "__DCAT_DEPLOY_BRANCH_NAME__",
        "_ENCRYPTED_GITHUB_TOKEN": "__ENCRYPTED_GITHUB_TOKEN__",
        "_KEYRING_REGION": "__KMS_KEYRING_REGION__",
        "_KEYRING": "__KMS_KEYRING__",
        "_KEY": "__KMS_KEY__",
        "_DEST_BUCKET": "__DEST_BUCKET__"
    }
}
